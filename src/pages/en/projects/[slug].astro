---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Navbar from '../../../components/Navbar.astro';
import Footer from '../../../components/Footer.astro';
import ProjectHeader from '../../../components/ProjectHeader.astro';
import ProjectHighlights from '../../../components/ProjectHighlights.astro';
import ProjectSection from '../../../components/ProjectSection.astro';
import ScreenshotPlaceholder from '../../../components/ScreenshotPlaceholder.astro';
import { useTranslations, getLocalizedPath, getProjectPath } from '../../../i18n/utils';
import type { Lang } from '../../../i18n/utils';

export function getStaticPaths() {
  return [
    { params: { slug: 'presidential-assistant' } },
    { params: { slug: 'roli-dashboard' } },
    { params: { slug: 'statement-engine' } },
  ];
}

const lang: Lang = 'en';
const { slug } = Astro.params;
const t = useTranslations(lang);
const project = t.projectDetails[slug as keyof typeof t.projectDetails];
const labels = t.projectDetail;
const currentPath = getProjectPath(lang, slug!);

const hasScreenshotCaptions = project.screenshotCaptions && project.screenshots && project.screenshots.length > 0;
---

<BaseLayout title={project.meta.title} description={project.meta.description} lang={lang}>
  <Navbar lang={lang} currentPath={currentPath} />
  <main class="project-page">
    <div class="container">
      <ProjectHeader
        lang={lang}
        title={project.header.title}
        subtitle={project.header.subtitle}
        status={project.header.status}
        statusKey={project.header.statusKey}
      />
    </div>

    <!-- Overview + inline first screenshot -->
    <ProjectSection title={labels.overviewTitle}>
      <div class="prose">
        {project.overview.map((p: string) => <p>{p}</p>)}
      </div>
      {hasScreenshotCaptions && (
        <figure class="inline-screenshot">
          <img src={project.screenshots[0]} alt={project.screenshotCaptions[0]} class="screenshot-img" loading="lazy" />
          <figcaption>{project.screenshotCaptions[0]}</figcaption>
        </figure>
      )}
      {project.header.liveUrl && (
        <a href={project.header.liveUrl} target="_blank" rel="noopener noreferrer" class="live-link">
          {labels.liveLabel} &rarr;
        </a>
      )}
    </ProjectSection>

    <!-- Key figures -->
    <ProjectSection title={labels.highlightsTitle} alt>
      <ProjectHighlights items={project.highlights} />
    </ProjectSection>

    <!-- Trust principles (conditional) -->
    {project.trustPrinciples && (
      <ProjectSection title={project.trustPrinciples.title}>
        <div class="trust-grid">
          {project.trustPrinciples.items.map((item: { title: string; body: string }) => (
            <div class="trust-card">
              <h3 class="trust-card__title">{item.title}</h3>
              <p class="trust-card__body">{item.body}</p>
            </div>
          ))}
        </div>
      </ProjectSection>
    )}

    <!-- How it works -->
    <ProjectSection title={labels.howItWorksTitle} alt={!!project.trustPrinciples}>
      <div class="how-it-works">
        {project.howItWorks.map((section: { title: string; body: string }) => (
          <div class="how-it-works__item">
            <h3>{section.title}</h3>
            <p>{section.body}</p>
          </div>
        ))}
      </div>
    </ProjectSection>

    <!-- Operation modes table (conditional) -->
    {project.operationModes && (
      <ProjectSection title={project.operationModes.title}>
        <p class="section-desc">{project.operationModes.description}</p>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                {project.operationModes.columns.map((col: string) => <th>{col}</th>)}
              </tr>
            </thead>
            <tbody>
              {project.operationModes.modes.map((m: { mode: string; trigger: string; example: string; safeguard: string }) => (
                <tr>
                  <td><strong>{m.mode}</strong></td>
                  <td>{m.trigger}</td>
                  <td class="example-cell">{m.example}</td>
                  <td>{m.safeguard}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </ProjectSection>
    )}

    <!-- In action: second screenshot with caption (conditional) -->
    {hasScreenshotCaptions && project.screenshots[1] && (
      <ProjectSection title={labels.inActionTitle} alt>
        <figure class="inline-screenshot inline-screenshot--full">
          <img src={project.screenshots[1]} alt={project.screenshotCaptions[1]} class="screenshot-img" loading="lazy" />
          <figcaption>{project.screenshotCaptions[1]}</figcaption>
        </figure>
      </ProjectSection>
    )}

    <!-- Source breakdown table (conditional) -->
    {project.sourceBreakdown && (
      <ProjectSection title={project.sourceBreakdown.title}>
        <p class="section-desc">{project.sourceBreakdown.description}</p>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                {project.sourceBreakdown.columns.map((col: string) => <th>{col}</th>)}
              </tr>
            </thead>
            <tbody>
              {project.sourceBreakdown.rows.map((row: { type: string; sources: string; candidates: string }) => (
                <tr>
                  <td>{row.type}</td>
                  <td class="num-cell">{row.sources}</td>
                  <td class="num-cell">{row.candidates}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </ProjectSection>
    )}

    <!-- Fallback: screenshots section for projects WITHOUT captions -->
    {!hasScreenshotCaptions && (
      <ProjectSection title={labels.screenshotsTitle}>
        <div class="screenshots-grid">
          {project.screenshots && project.screenshots.length > 0 ? (
            project.screenshots.map((src: string, i: number) => (
              <img src={src} alt={`${project.header.title} screenshot ${i + 1}`} class="screenshot-img" loading="lazy" />
            ))
          ) : (
            <>
              <ScreenshotPlaceholder label={labels.screenshotPlaceholder} />
              <ScreenshotPlaceholder label={labels.screenshotPlaceholder} />
            </>
          )}
        </div>
      </ProjectSection>
    )}

    <!-- Limitations -->
    <ProjectSection title={labels.limitationsTitle} alt>
      <ul class="limitations-list">
        {project.limitations.map((item: string) => (
          <li>{item}</li>
        ))}
      </ul>
    </ProjectSection>

    <section class="project-cta">
      <div class="container project-cta__inner">
        <p class="project-cta__text">{labels.ctaText}</p>
        <a href={getLocalizedPath(lang, 'contact')} class="project-cta__button">{labels.ctaButton}</a>
      </div>
    </section>
  </main>
  <Footer lang={lang} />
</BaseLayout>

<style>
  .project-page {
    padding-top: 64px;
  }

  .prose {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    max-width: 720px;
  }

  .prose p {
    line-height: var(--lh-normal);
    color: var(--color-text-secondary);
  }

  /* Inline screenshots with captions */
  .inline-screenshot {
    margin-top: var(--space-xl);
    max-width: 900px;
  }

  .inline-screenshot--full {
    max-width: 100%;
  }

  .inline-screenshot figcaption {
    margin-top: var(--space-sm);
    font-size: var(--fs-sm);
    color: var(--color-text-secondary);
    text-align: center;
    font-style: italic;
  }

  /* Trust principles grid */
  .trust-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }

  @media (min-width: 768px) {
    .trust-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .trust-card {
    background: var(--color-section-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
  }

  .trust-card__title {
    font-size: var(--fs-md);
    font-weight: var(--fw-semibold);
    margin-bottom: var(--space-xs);
  }

  .trust-card__body {
    font-size: var(--fs-sm);
    color: var(--color-text-secondary);
    line-height: var(--lh-normal);
  }

  /* How it works */
  .how-it-works {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .how-it-works__item h3 {
    margin-bottom: var(--space-sm);
  }

  .how-it-works__item p {
    line-height: var(--lh-normal);
    color: var(--color-text-secondary);
    max-width: 720px;
  }

  /* Section description text */
  .section-desc {
    color: var(--color-text-secondary);
    line-height: var(--lh-normal);
    margin-bottom: var(--space-lg);
    max-width: 720px;
  }

  /* Data tables */
  .table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--fs-sm);
    min-width: 600px;
  }

  .data-table th {
    text-align: left;
    font-weight: var(--fw-semibold);
    padding: var(--space-sm) var(--space-md);
    border-bottom: 2px solid var(--color-border);
    white-space: nowrap;
    color: var(--color-text);
  }

  .data-table td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    line-height: var(--lh-snug);
    vertical-align: top;
  }

  .data-table tbody tr:last-child td {
    border-bottom: none;
  }

  .data-table tbody tr:hover {
    background-color: var(--color-section-alt);
  }

  .example-cell {
    font-style: italic;
    font-size: var(--fs-xs);
  }

  .num-cell {
    text-align: center;
    font-weight: var(--fw-semibold);
    color: var(--color-accent);
  }

  /* Live link button */
  .live-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 0.625rem 1.5rem;
    font-size: var(--fs-base);
    font-weight: var(--fw-semibold);
    color: #fff;
    background-color: var(--color-accent);
    border-radius: var(--border-radius);
    transition: background-color var(--transition-fast);
    width: fit-content;
    margin-top: var(--space-lg);
  }

  .live-link:hover {
    color: #fff;
    background-color: var(--color-accent-dark);
  }

  /* Screenshots grid (fallback for projects without captions) */
  .screenshots-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  .screenshot-img {
    width: 100%;
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--color-border);
  }

  @media (min-width: 768px) {
    .screenshots-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Limitations list */
  .limitations-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    max-width: 720px;
  }

  .limitations-list li {
    position: relative;
    padding-left: var(--space-lg);
    font-size: var(--fs-sm);
    color: var(--color-text-secondary);
    line-height: var(--lh-normal);
  }

  .limitations-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.6em;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background-color: var(--color-accent);
  }

  /* CTA section */
  .project-cta {
    padding: var(--space-3xl) 0;
  }

  .project-cta__inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-lg);
    text-align: center;
  }

  .project-cta__text {
    font-size: var(--fs-lg);
    font-weight: var(--fw-medium);
    color: var(--color-text);
  }

  .project-cta__button {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.75rem;
    font-size: var(--fs-base);
    font-weight: var(--fw-semibold);
    color: #fff;
    background-color: var(--color-accent);
    border-radius: var(--border-radius);
    transition: background-color var(--transition-fast);
  }

  .project-cta__button:hover {
    background-color: var(--color-accent-dark);
  }
</style>
